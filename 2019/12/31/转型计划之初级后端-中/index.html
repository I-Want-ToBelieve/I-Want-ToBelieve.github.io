<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <link rel="manifest" href="/images/manifest.json">
  <meta name="msapplication-config" content="/images/browserconfig.xml">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.loli.net/css?family=Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"floatsyi.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="参考 转型计划之初级后端(上) Securely build, share and run any application, anywhere: docker 有类型的 javascript : typescript docs.nestjs.com 精读 《Nestjs 文档》 OpenAPI-Specification OpenAPI（Swagger） nest-starter  资源 nod">
<meta property="og:type" content="article">
<meta property="og:title" content="转型计划之初级后端(中)">
<meta property="og:url" content="http://floatsyi.com/2019/12/31/%E8%BD%AC%E5%9E%8B%E8%AE%A1%E5%88%92%E4%B9%8B%E5%88%9D%E7%BA%A7%E5%90%8E%E7%AB%AF-%E4%B8%AD/index.html">
<meta property="og:site_name" content="backtolife">
<meta property="og:description" content="参考 转型计划之初级后端(上) Securely build, share and run any application, anywhere: docker 有类型的 javascript : typescript docs.nestjs.com 精读 《Nestjs 文档》 OpenAPI-Specification OpenAPI（Swagger） nest-starter  资源 nod">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://r.photo.store.qq.com/psc?/V12iDrZG1mzmnh/uMeul31pGB4ZvQm8Ou4xcdR2daHKd13U6t.v6WRly*a.CgaDhpSzGeas6iqBV.dNLGWNm5.BojkFMm6lUpcbLd0uFVhQzCZ07NWNUWrADSs!/r">
<meta property="og:image" content="http://r.photo.store.qq.com/psc?/V12iDrZG1mzmnh/uMeul31pGB4ZvQm8Ou4xcbjLXnvGTHkHhtZOEjIHS1aECdpA3zT9vAep9ksCH7F9.2ulP3cU34*17Ls1cSqSgcbGmBfh6JT*pHbyyKwd7zA!/r">
<meta property="article:published_time" content="2019-12-31T00:58:37.000Z">
<meta property="article:modified_time" content="2021-07-02T09:53:04.738Z">
<meta property="article:author" content="backtolife">
<meta property="article:tag" content="初级后端">
<meta property="article:tag" content="转型计划">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://r.photo.store.qq.com/psc?/V12iDrZG1mzmnh/uMeul31pGB4ZvQm8Ou4xcdR2daHKd13U6t.v6WRly*a.CgaDhpSzGeas6iqBV.dNLGWNm5.BojkFMm6lUpcbLd0uFVhQzCZ07NWNUWrADSs!/r">

<link rel="canonical" href="http://floatsyi.com/2019/12/31/%E8%BD%AC%E5%9E%8B%E8%AE%A1%E5%88%92%E4%B9%8B%E5%88%9D%E7%BA%A7%E5%90%8E%E7%AB%AF-%E4%B8%AD/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>转型计划之初级后端(中) | backtolife</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="backtolife" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">backtolife</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://floatsyi.com/2019/12/31/%E8%BD%AC%E5%9E%8B%E8%AE%A1%E5%88%92%E4%B9%8B%E5%88%9D%E7%BA%A7%E5%90%8E%E7%AB%AF-%E4%B8%AD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="backtolife">
      <meta itemprop="description" content="21 世纪两大浪漫, 五线谱与二进制.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="backtolife">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          转型计划之初级后端(中)
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-12-31 08:58:37" itemprop="dateCreated datePublished" datetime="2019-12-31T08:58:37+08:00">2019-12-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-02 17:53:04" itemprop="dateModified" datetime="2021-07-02T17:53:04+08:00">2021-07-02</time>
              </span>

          
            <span id="/2019/12/31/%E8%BD%AC%E5%9E%8B%E8%AE%A1%E5%88%92%E4%B9%8B%E5%88%9D%E7%BA%A7%E5%90%8E%E7%AB%AF-%E4%B8%AD/" class="post-meta-item leancloud_visitors" data-flag-title="转型计划之初级后端(中)" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2019/12/31/%E8%BD%AC%E5%9E%8B%E8%AE%A1%E5%88%92%E4%B9%8B%E5%88%9D%E7%BA%A7%E5%90%8E%E7%AB%AF-%E4%B8%AD/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/12/31/转型计划之初级后端-中/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><img src="http://r.photo.store.qq.com/psc?/V12iDrZG1mzmnh/uMeul31pGB4ZvQm8Ou4xcdR2daHKd13U6t.v6WRly*a.CgaDhpSzGeas6iqBV.dNLGWNm5.BojkFMm6lUpcbLd0uFVhQzCZ07NWNUWrADSs!/r" alt="年轻人， 你渴望力量吗"></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://floatsyi.com/2019/12/30/%E8%BD%AC%E5%9E%8B%E8%AE%A1%E5%88%92%E4%B9%8B%E5%88%9D%E7%BA%A7%E5%90%8E%E7%AB%AF-%E4%B8%8A/">转型计划之初级后端(上)</a></li>
<li><a href="https://floatsyi.com/2019/12/29/Securely-build-share-and-run-any-application-anywhere-docker/">Securely build, share and run any application, anywhere: docker</a></li>
<li><a href="https://floatsyi.com/2019/10/07/%E6%9C%89%E7%B1%BB%E5%9E%8B%E7%9A%84-javascript-typescript/">有类型的 javascript : typescript</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.nestjs.com/">docs.nestjs.com</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/28621374">精读 《Nestjs 文档》</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/OAI/OpenAPI-Specification">OpenAPI-Specification</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.nestjs.com/recipes/swagger">OpenAPI（Swagger）</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/MarkNjunge/nest-starter">nest-starter</a></li>
</ul>
<h2 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/nodejs/node">nodejs</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/microsoft/TypeScript">typescript</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/nestjs/nest">nestjs</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/typeorm/typeorm">typeorm</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mysqljs/mysql">mysql</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/topics/docker">docker</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/lujakob/nestjs-realworld-example-app">nestjs-realworld-example-app</a></li>
<li><a target="_blank" rel="noopener" href="https://yeoman.io/">yeoman</a></li>
<li><a target="_blank" rel="noopener" href="https://hub.docker.com/_/mysql">hub.docker.com: mysql</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/babel/babel">babel</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/TypeStrong/ts-node">ts-node</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/topcoder-platform/challenge-api">challenge-api</a></li>
<li><a target="_blank" rel="noopener" href="https://www.getpostman.com/">postman</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/winstonjs/winston">winston</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/gremo/nest-winston">nestjs-winston</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/remy/nodemon">nodemon</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/ReactiveX/rxjs">rxjs</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/typestack/class-validator">class-validator</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/typestack/class-transformer">class-transformer</a></li>
</ul>
<span id="more"></span>

<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><a href="https://floatsyi.com/2019/12/30/%E8%BD%AC%E5%9E%8B%E8%AE%A1%E5%88%92%E4%B9%8B%E5%88%9D%E7%BA%A7%E5%90%8E%E7%AB%AF-%E4%B8%8A/">转型计划之初级后端(上)</a> 是解剖分析部分， 这篇是重构部分，利用完整的重构来检验自己是否已经达到融会贯通的程度。</p>
<h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><ul>
<li><a href="https://floatsyi.com/2019/12/30/%E8%BD%AC%E5%9E%8B%E8%AE%A1%E5%88%92%E4%B9%8B%E5%88%9D%E7%BA%A7%E5%90%8E%E7%AB%AF-%E4%B8%8A/">转型计划之初级后端(上)</a></li>
<li><a href="https://floatsyi.com/2019/12/29/Securely-build-share-and-run-any-application-anywhere-docker/">Securely build, share and run any application, anywhere: docker</a></li>
<li><a href="https://floatsyi.com/2019/10/07/%E6%9C%89%E7%B1%BB%E5%9E%8B%E7%9A%84-javascript-typescript/">有类型的 javascript : typescript</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.nestjs.com/">docs.nestjs.com</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/OAI/OpenAPI-Specification">OpenAPI-Specification</a></li>
<li><a target="_blank" rel="noopener" href="https://cn.rx.js.org/">rxjs 中文网</a></li>
</ul>
<h2 id="分析样板"><a href="#分析样板" class="headerlink" title="分析样板"></a>分析样板</h2><h3 id="寻找合适的样板"><a href="#寻找合适的样板" class="headerlink" title="寻找合适的样板"></a>寻找合适的样板</h3><p>第一步当然是要找一个好的 Boilerplate， 一般情况下是在 <a target="_blank" rel="noopener" href="https://yeoman.io/">yeoman</a> 这个网站找<br>这里我在了解学习 nestjs 的过程中在 github 上发现了一个很不错的 Boilerplate: <a target="_blank" rel="noopener" href="https://github.com/lujakob/nestjs-realworld-example-app">nestjs-realworld-example-app</a>, 所以就决定是它了。</p>
<h3 id="使用-mysql-容器"><a href="#使用-mysql-容器" class="headerlink" title="使用 mysql 容器"></a>使用 mysql 容器</h3><p>先把 <a target="_blank" rel="noopener" href="https://github.com/lujakob/nestjs-realworld-example-app">nestjs-realworld-example-app</a> <code>git clone https://github.com/lujakob/nestjs-realworld-example-app.git</code> 到本地<br>然后读 README.md 文档，查看开发环境是否符合要求，然后按照 README.md 文档的提示将这个 Boilerplate 运行起来, 确保没有错误发生。</p>
<p>按照  README.md 文档的要求， 需要安装 mysql 数据库，这里我一开始是决定使用 WSL 来做这件事情， 但不久前，我看完了 docker 的文档，所以决定使用 docker 来做这件事情， 这样更符合现代的开发部署流程。<br>docker 的安装与使用请参考: <a href="https://floatsyi.com/2019/12/29/Securely-build-share-and-run-any-application-anywhere-docker/">Securely build, share and run any application, anywhere: docker</a><br>在项目根目录 <code>mkdir mysql</code> <code>touch docker-compose.yml</code><br>docker-compose.yml:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.1&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">--default-authentication-plugin=mysql_native_password</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">rootpassword</span></span><br><span class="line">      <span class="attr">MYSQL_DATABASE:</span> <span class="string">nestjsrealworld</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3306:3306&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./mysql:/var/lib/mysql</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">adminer:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">adminer</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8080</span><span class="string">:8080</span></span><br></pre></td></tr></table></figure>
<p>  docker-compose.yml 配置文件的编写请参考: <a target="_blank" rel="noopener" href="https://hub.docker.com/_/mysql">hub.docker.com: mysql</a><br>  然后按照 README.md 要求 <code>cp ormconfig.json.example ormconfig.json</code><br>  然后修改 ormconfig.json 内容如下:<br>  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;mysql&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;host&quot;</span>: <span class="string">&quot;localhost&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;port&quot;</span>: <span class="number">3306</span>,</span><br><span class="line">  <span class="attr">&quot;username&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;password&quot;</span>: <span class="string">&quot;rootpassword&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;database&quot;</span>: <span class="string">&quot;nestjsrealworld&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;entities&quot;</span>: [<span class="string">&quot;src/**/**.entity&#123;.ts,.js&#125;&quot;</span>],</span><br><span class="line">  <span class="attr">&quot;synchronize&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>现在 README.md 要求的开发环境已经准备好了， 只需查看 package.json 的 script 字段<br>在这里加入了 <code>&quot;db&quot;: &quot;docker-compose up -d&quot;</code> 一行<br>package.json:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;start&quot;</span>: <span class="string">&quot;node index.js&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;start:watch&quot;</span>: <span class="string">&quot;nodemon&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;prestart:prod&quot;</span>: <span class="string">&quot;tsc&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;start:prod&quot;</span>: <span class="string">&quot;node dist/main.js&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;test&quot;</span>: <span class="string">&quot;jest --config=jest.config.json --forceExit&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;test:watch&quot;</span>: <span class="string">&quot;jest --watch --config=jest.config.json&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;test:coverage&quot;</span>: <span class="string">&quot;jest --config=jest.config.json --coverage --coverageDirectory=coverage&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;db&quot;</span>: <span class="string">&quot;docker-compose up -d&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  现在先后执行 <code>npm run db</code> <code>npm run start</code>  项目就运行起来了。<br>  默认情况下 docker 是开机自启动的， 这样子就算你重启计算机 docker 也会自动运行你设置的 <code>restart: always</code> 容器<br>  因此 <code>npm run db</code> 只需要首次执行时， 执行一次即可.</p>
<h3 id="分析入口文件"><a href="#分析入口文件" class="headerlink" title="分析入口文件"></a>分析入口文件</h3><p>确保项目能够运行后， 打开入口文件 <a target="_blank" rel="noopener" href="https://sourcegraph.com/github.com/lujakob/nestjs-realworld-example-app/-/blob/index.js">index.js</a><br>index.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* eslint-disable */</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;ts-node/register&#x27;</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;./src/main&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>  竟然是个 js 文件， 而不是 ts.<br>  可以看到这里引入了一个 <a target="_blank" rel="noopener" href="https://github.com/TypeStrong/ts-node">ts-node</a> 的 register， 然后才是真正的入口文件 <a target="_blank" rel="noopener" href="https://sourcegraph.com/github.com/lujakob/nestjs-realworld-example-app/-/blob/src/main.ts">‘./src/main’</a><br>  如果你用过 <a target="_blank" rel="noopener" href="https://github.com/babel/babel">babel</a> 的话， 你就会知道 <a target="_blank" rel="noopener" href="https://github.com/babel/babel">babel</a> 也有一个 @babel/register， 可以直接运行 ES Next 的代码.<br>  那么这个 <a target="_blank" rel="noopener" href="https://github.com/TypeStrong/ts-node">ts-node</a> 应该就是可以直接运行 <a target="_blank" rel="noopener" href="https://github.com/microsoft/TypeScript">ts</a> 的 <a target="_blank" rel="noopener" href="https://github.com/nodejs/node">nodejs</a> 了.<br>  这可是一个好东西， 所以点开 <a target="_blank" rel="noopener" href="https://github.com/TypeStrong/ts-node">ts-node</a> 点个 star 然后继续查看真正的入口文件 <a target="_blank" rel="noopener" href="https://sourcegraph.com/github.com/lujakob/nestjs-realworld-example-app/-/blob/src/main.ts">‘./src/main’</a><br>main.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; NestFactory &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/core&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; ApplicationModule &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.module&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; SwaggerModule, DocumentBuilder &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/swagger&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span> (<span class="params"></span>): <span class="title">Promise</span>&lt;<span class="title">void</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> appOptions = &#123; <span class="attr">cors</span>: <span class="literal">true</span> &#125;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> NestFactory.create(ApplicationModule, appOptions)</span><br><span class="line">  app.setGlobalPrefix(<span class="string">&#x27;api&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> options = <span class="keyword">new</span> DocumentBuilder()</span><br><span class="line">    .setTitle(<span class="string">&#x27;NestJS Realworld Example App&#x27;</span>)</span><br><span class="line">    .setDescription(<span class="string">&#x27;The Realworld API description&#x27;</span>)</span><br><span class="line">    .setVersion(<span class="string">&#x27;1.0&#x27;</span>)</span><br><span class="line">    .setBasePath(<span class="string">&#x27;api&#x27;</span>)</span><br><span class="line">    .addBearerAuth()</span><br><span class="line">    .build()</span><br><span class="line">  <span class="keyword">const</span> <span class="built_in">document</span> = SwaggerModule.createDocument(app, options)</span><br><span class="line">  SwaggerModule.setup(<span class="string">&#x27;/docs&#x27;</span>, app, <span class="built_in">document</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> app.listen(<span class="number">3000</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// eslint-disable-next-line @typescript-eslint/no-floating-promises</span></span><br><span class="line">bootstrap()</span><br></pre></td></tr></table></figure>
<p>  这里我们可以看到入口文件的意图很明显， 定义并执行了一个 bootstrap 函数， bootstrap 函数做了两件事情:</p>
<ol>
<li><p>一个是使用 NestFactory 工厂类的静态方法 create 返回一个实现 INestApplication 接口的应用程序对象</p>
</li>
<li><p>还有一件事情是添加了一个新的路由 ‘/docs’, 指向 Swagger UI 页面。<br>Swagger UI 这里不做展开， 请参考: <a target="_blank" rel="noopener" href="https://docs.nestjs.com/recipes/swagger">OpenAPI（Swagger）</a></p>
</li>
</ol>
<p>值得一提的是， nest 官网文档 <a target="_blank" rel="noopener" href="https://docs.nestjs.com/">docs.nestjs.com</a> 说:</p>
<blockquote>
<p>NestFactory exposes a few static methods that allow creating an application instance. The create() method returns an application object, which fulfills the INestApplication interface.</p>
</blockquote>
<p>关键字 <strong>static methods</strong>, 这里我看了 NestFactory 方法的实现: <a target="_blank" rel="noopener" href="https://sourcegraph.com/github.com/nestjs/nest/-/blob/packages/core/nest-factory.ts#L252:14">github.com/nestjs/nest/-/blob/packages/core/nest-factory.ts#L252:14</a> 发现并不是我想象的 <em>类 NestFactory 上定义了一个 NestFactory.create 的静态方法</em>，而是 NestFactory 只是类 NestFactoryStatic 的实例， 而所谓的静态方法只是 NestFactoryStatic 类的成员方法。<br>可是 typescript 明明支持 static 关键字啊！！为什么要定义一个 NestFactoryStatic 类？ NestFactoryStatic类的名字里有个 Static， 所以它的成员方法就变为静态方法也是比较有意思的地方。<em>静态</em>类的成员方法简称静态方法， 很合理。哈哈。<br>同样值得一提的是，静态方法 create 是一个多态方法， 这一点文档里面没有提到， 而且它的返回值竟然是一个被 new Proxy 代理包装后的对象: [github.com/nestjs/nest/-/blob/packages/core/nest-factory.ts#L228:17]:<a target="_blank" rel="noopener" href="https://sourcegraph.com/github.com/nestjs/nest/-/blob/packages/core/nest-factory.ts#L228:17">https://sourcegraph.com/github.com/nestjs/nest/-/blob/packages/core/nest-factory.ts#L228:17</a><br>其实 NestFactory 的实现是没必要去知道的， 如果一个 api 必须看源码才能知道怎么用， 这是违反最小知识原则， 只是觉得有趣纪录一下。<br><img src="http://r.photo.store.qq.com/psc?/V12iDrZG1mzmnh/uMeul31pGB4ZvQm8Ou4xcbjLXnvGTHkHhtZOEjIHS1aECdpA3zT9vAep9ksCH7F9.2ulP3cU34*17Ls1cSqSgcbGmBfh6JT*pHbyyKwd7zA!/r" alt="wczgsxhnba"><br>真正需要了解的是 create 的参数: appOptions, 这个时候静态类型语言的优势就体现出来了， 可以选中 create 直接按快捷键 <code>F12</code> 找到 create 的类型定义</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create&lt;T <span class="keyword">extends</span> INestApplication = INestApplication&gt;(<span class="built_in">module</span>: <span class="built_in">any</span>, options?: NestApplicationOptions): <span class="built_in">Promise</span>&lt;T&gt;;</span><br></pre></td></tr></table></figure>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create&lt;T <span class="keyword">extends</span> INestApplication = INestApplication&gt;(<span class="built_in">module</span>: <span class="built_in">any</span>, <span class="attr">httpAdapter</span>: AbstractHttpAdapter, options?: NestApplicationOptions): <span class="built_in">Promise</span>&lt;T&gt;;</span><br></pre></td></tr></table></figure>

<p>options 是一个可选的， 需要尊重 NestApplicationOptions 类型的对象， 选中 NestApplicationOptions 继续按快捷键 <code>F12</code>：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; CorsOptions &#125; <span class="keyword">from</span> <span class="string">&#x27;./external/cors-options.interface&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; HttpsOptions &#125; <span class="keyword">from</span> <span class="string">&#x27;./external/https-options.interface&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; NestApplicationContextOptions &#125; <span class="keyword">from</span> <span class="string">&#x27;./nest-application-context-options.interface&#x27;</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@publicApi</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> NestApplicationOptions <span class="keyword">extends</span> NestApplicationContextOptions &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * CORS options from [CORS package](https://github.com/expressjs/cors#configuration-options)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    cors?: <span class="built_in">boolean</span> | CorsOptions;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Whether to use underlying platform body parser.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    bodyParser?: <span class="built_in">boolean</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Set of configurable HTTPS options</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    httpsOptions?: HttpsOptions;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>写的很明白， 没什么好说的。<br>入口文件分析完毕， 服务器运行在 3000 端口， 所以可以点开 <a target="_blank" rel="noopener" href="http://127.0.0.1:3000/docs/">http://127.0.0.1:3000/docs/</a> 玩玩 Swagger UI</p>
<h3 id="分析-module"><a href="#分析-module" class="headerlink" title="分析 module"></a>分析 module</h3><p>接下来就可以看一看入口文件中导入的 <a target="_blank" rel="noopener" href="https://sourcegraph.com/github.com/lujakob/nestjs-realworld-example-app/-/blob/src/app.module.ts">‘./app.module’</a></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppController &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.controller&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ArticleModule &#125; <span class="keyword">from</span> <span class="string">&#x27;./article/article.module&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UserModule &#125; <span class="keyword">from</span> <span class="string">&#x27;./user/user.module&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; TypeOrmModule &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Connection &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ProfileModule &#125; <span class="keyword">from</span> <span class="string">&#x27;./profile/profile.module&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; TagModule &#125; <span class="keyword">from</span> <span class="string">&#x27;./tag/tag.module&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [</span><br><span class="line">    TypeOrmModule.forRoot(),</span><br><span class="line">    ArticleModule,</span><br><span class="line">    UserModule,</span><br><span class="line">    ProfileModule,</span><br><span class="line">    TagModule</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">controllers</span>: [</span><br><span class="line">    AppController</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">providers</span>: []</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationModule</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> connection: Connection</span>)</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  可以看到 app.module 导入了所有的业务模块（module 与 controller）， 这里可以对照一下项目结构</p>
<p>  可以发现所有的业务模块都使用单独一个文件夹区分， 每个业务模块中都有 module controller service entity interface 和 dto， 同样的所有的单个业务模块的这些文件在 module 里面被注入。 module 是单个业务模块的中心， 而所有的业务模块都向 app.module 汇集。<br>  从单个业务模块向入口文件看， 应用逻辑呈收敛状， 反之则呈放射状。<br>  而且可以看到 module implements NestModule  的 configure(consumer: MiddlewareConsumer)  方法 有一个被注入的 consumer: MiddlewareConsumer<br>  对象， 这个 consumer 对象, 可以给所有在此声明的路径与方法应用中间件。 如果要用一个词形容 module 的话， 那就是中心化。<br>article.module.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [TypeOrmModule.forFeature([ArticleEntity, Comment, UserEntity, FollowsEntity]), UserModule],</span><br><span class="line">  <span class="attr">providers</span>: [ArticleService],</span><br><span class="line">  <span class="attr">controllers</span>: [</span><br><span class="line">    ArticleController</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ArticleModule</span> <span class="title">implements</span> <span class="title">NestModule</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="title">configure</span>(<span class="params">consumer: MiddlewareConsumer</span>)</span> &#123;</span><br><span class="line">    consumer</span><br><span class="line">      .apply(AuthMiddleware)</span><br><span class="line">      .forRoutes(</span><br><span class="line">        &#123;<span class="attr">path</span>: <span class="string">&#x27;articles/feed&#x27;</span>, <span class="attr">method</span>: RequestMethod.GET&#125;,</span><br><span class="line">        &#123;<span class="attr">path</span>: <span class="string">&#x27;articles&#x27;</span>, <span class="attr">method</span>: RequestMethod.POST&#125;,</span><br><span class="line">        &#123;<span class="attr">path</span>: <span class="string">&#x27;articles/:slug&#x27;</span>, <span class="attr">method</span>: RequestMethod.DELETE&#125;,</span><br><span class="line">        &#123;<span class="attr">path</span>: <span class="string">&#x27;articles/:slug&#x27;</span>, <span class="attr">method</span>: RequestMethod.PUT&#125;,</span><br><span class="line">        &#123;<span class="attr">path</span>: <span class="string">&#x27;articles/:slug/comments&#x27;</span>, <span class="attr">method</span>: RequestMethod.POST&#125;,</span><br><span class="line">        &#123;<span class="attr">path</span>: <span class="string">&#x27;articles/:slug/comments/:id&#x27;</span>, <span class="attr">method</span>: RequestMethod.DELETE&#125;,</span><br><span class="line">        &#123;<span class="attr">path</span>: <span class="string">&#x27;articles/:slug/favorite&#x27;</span>, <span class="attr">method</span>: RequestMethod.POST&#125;,</span><br><span class="line">        &#123;<span class="attr">path</span>: <span class="string">&#x27;articles/:slug/favorite&#x27;</span>, <span class="attr">method</span>: RequestMethod.DELETE&#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  值得注意的是这一行中 <code>imports: [TypeOrmModule.forFeature([ArticleEntity, Comment, UserEntity, FollowsEntity]), UserModule],</code> 除了 UserModule 其他都是与数据库对应的 Entity， 这个 UserModule 的特殊之处是通过 <code>exports: [UserService]</code> 导出了 UserService (在 user.module.ts 文件中)， 使得所有 imports UserModule 的 Controller 都可以使用 UserService。 这一点(Shared modules)在 <a target="_blank" rel="noopener" href="https://github.com/nestjs/nest">nestjs</a> 的官方文档中已经说的很清楚了: <a target="_blank" rel="noopener" href="https://docs.nestjs.com/modules">https://docs.nestjs.com/modules</a>:</p>
<blockquote>
<p>Now any module that imports the CatsModule has access to the CatsService and will share the same instance with all other modules that import it as well.</p>
</blockquote>
<h3 id="分析-controller"><a href="#分析-controller" class="headerlink" title="分析 controller"></a>分析 controller</h3><p>module 看完后看 controller<br>article.controller.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Get, Post, Body, Put, Delete, Query, Param, Controller &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; Request &#125; <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; ArticleService &#125; <span class="keyword">from</span> <span class="string">&#x27;./article.service&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; CreateArticleDto, CreateCommentDto &#125; <span class="keyword">from</span> <span class="string">&#x27;./dto&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; ArticlesRO, ArticleRO, CommentsRO &#125; <span class="keyword">from</span> <span class="string">&#x27;./article.interface&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; User &#125; <span class="keyword">from</span> <span class="string">&#x27;../user/user.decorator&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  ApiUseTags,</span><br><span class="line">  ApiBearerAuth,</span><br><span class="line">  ApiResponse,</span><br><span class="line">  ApiOperation</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/swagger&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiBearerAuth</span>()</span><br><span class="line"><span class="meta">@ApiUseTags</span>(<span class="string">&#x27;articles&#x27;</span>)</span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;articles&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ArticleController</span> </span>&#123;</span><br><span class="line">  <span class="title">constructor</span> (<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> articleService: ArticleService</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@ApiOperation</span>(&#123; <span class="attr">title</span>: <span class="string">&#x27;Get all articles&#x27;</span> &#125;)</span><br><span class="line">  <span class="meta">@ApiResponse</span>(&#123; <span class="attr">status</span>: <span class="number">200</span>, <span class="attr">description</span>: <span class="string">&#x27;Return all articles.&#x27;</span> &#125;)</span><br><span class="line">  <span class="meta">@Get</span>()</span><br><span class="line">  <span class="keyword">async</span> findAll (<span class="meta">@Query</span>() query): <span class="built_in">Promise</span>&lt;ArticlesRO&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="built_in">this</span>.articleService.findAll(query)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Get</span>(<span class="string">&#x27;:slug&#x27;</span>)</span><br><span class="line">  <span class="keyword">async</span> findOne (<span class="meta">@Param</span>(<span class="string">&#x27;slug&#x27;</span>) slug): <span class="built_in">Promise</span>&lt;ArticleRO&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="built_in">this</span>.articleService.findOne(&#123; slug &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Get</span>(<span class="string">&#x27;:slug/comments&#x27;</span>)</span><br><span class="line">  <span class="keyword">async</span> findComments (<span class="meta">@Param</span>(<span class="string">&#x27;slug&#x27;</span>) slug): <span class="built_in">Promise</span>&lt;CommentsRO&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="built_in">this</span>.articleService.findComments(slug)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@ApiOperation</span>(&#123; <span class="attr">title</span>: <span class="string">&#x27;Create article&#x27;</span> &#125;)</span><br><span class="line">  <span class="meta">@ApiResponse</span>(&#123; <span class="attr">status</span>: <span class="number">201</span>, <span class="attr">description</span>: <span class="string">&#x27;The article has been successfully created.&#x27;</span> &#125;)</span><br><span class="line">  <span class="meta">@ApiResponse</span>(&#123; <span class="attr">status</span>: <span class="number">403</span>, <span class="attr">description</span>: <span class="string">&#x27;Forbidden.&#x27;</span> &#125;)</span><br><span class="line">  <span class="meta">@Post</span>()</span><br><span class="line">  <span class="keyword">async</span> create (<span class="meta">@User</span>(<span class="string">&#x27;id&#x27;</span>) userId: <span class="built_in">number</span>, <span class="meta">@Body</span>(<span class="string">&#x27;article&#x27;</span>) articleData: CreateArticleDto) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.articleService.create(userId, articleData)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@ApiOperation</span>(&#123; <span class="attr">title</span>: <span class="string">&#x27;Update article&#x27;</span> &#125;)</span><br><span class="line">  <span class="meta">@ApiResponse</span>(&#123; <span class="attr">status</span>: <span class="number">201</span>, <span class="attr">description</span>: <span class="string">&#x27;The article has been successfully updated.&#x27;</span> &#125;)</span><br><span class="line">  <span class="meta">@ApiResponse</span>(&#123; <span class="attr">status</span>: <span class="number">403</span>, <span class="attr">description</span>: <span class="string">&#x27;Forbidden.&#x27;</span> &#125;)</span><br><span class="line">  <span class="meta">@Put</span>(<span class="string">&#x27;:slug&#x27;</span>)</span><br><span class="line">  <span class="keyword">async</span> update (<span class="meta">@Param</span>() params, <span class="meta">@Body</span>(<span class="string">&#x27;article&#x27;</span>) articleData: CreateArticleDto) &#123;</span><br><span class="line">    <span class="comment">// Todo: update slug also when title gets changed</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.articleService.update(params.slug, articleData)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@ApiOperation</span>(&#123; <span class="attr">title</span>: <span class="string">&#x27;Delete article&#x27;</span> &#125;)</span><br><span class="line">  <span class="meta">@ApiResponse</span>(&#123; <span class="attr">status</span>: <span class="number">201</span>, <span class="attr">description</span>: <span class="string">&#x27;The article has been successfully deleted.&#x27;</span> &#125;)</span><br><span class="line">  <span class="meta">@ApiResponse</span>(&#123; <span class="attr">status</span>: <span class="number">403</span>, <span class="attr">description</span>: <span class="string">&#x27;Forbidden.&#x27;</span> &#125;)</span><br><span class="line">  <span class="meta">@Delete</span>(<span class="string">&#x27;:slug&#x27;</span>)</span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">delete</span> (<span class="meta">@Param</span>() params) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.articleService.delete(params.slug)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@ApiOperation</span>(&#123; <span class="attr">title</span>: <span class="string">&#x27;Create comment&#x27;</span> &#125;)</span><br><span class="line">  <span class="meta">@ApiResponse</span>(&#123; <span class="attr">status</span>: <span class="number">201</span>, <span class="attr">description</span>: <span class="string">&#x27;The comment has been successfully created.&#x27;</span> &#125;)</span><br><span class="line">  <span class="meta">@ApiResponse</span>(&#123; <span class="attr">status</span>: <span class="number">403</span>, <span class="attr">description</span>: <span class="string">&#x27;Forbidden.&#x27;</span> &#125;)</span><br><span class="line">  <span class="meta">@Post</span>(<span class="string">&#x27;:slug/comments&#x27;</span>)</span><br><span class="line">  <span class="keyword">async</span> createComment (<span class="meta">@Param</span>(<span class="string">&#x27;slug&#x27;</span>) slug, <span class="meta">@Body</span>(<span class="string">&#x27;comment&#x27;</span>) commentData: CreateCommentDto) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="built_in">this</span>.articleService.addComment(slug, commentData)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@ApiOperation</span>(&#123; <span class="attr">title</span>: <span class="string">&#x27;Delete comment&#x27;</span> &#125;)</span><br><span class="line">  <span class="meta">@ApiResponse</span>(&#123; <span class="attr">status</span>: <span class="number">201</span>, <span class="attr">description</span>: <span class="string">&#x27;The article has been successfully deleted.&#x27;</span> &#125;)</span><br><span class="line">  <span class="meta">@ApiResponse</span>(&#123; <span class="attr">status</span>: <span class="number">403</span>, <span class="attr">description</span>: <span class="string">&#x27;Forbidden.&#x27;</span> &#125;)</span><br><span class="line">  <span class="meta">@Delete</span>(<span class="string">&#x27;:slug/comments/:id&#x27;</span>)</span><br><span class="line">  <span class="keyword">async</span> deleteComment (<span class="meta">@Param</span>() params) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; slug, id &#125; = params</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="built_in">this</span>.articleService.deleteComment(slug, id)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@ApiOperation</span>(&#123; <span class="attr">title</span>: <span class="string">&#x27;Favorite article&#x27;</span> &#125;)</span><br><span class="line">  <span class="meta">@ApiResponse</span>(&#123; <span class="attr">status</span>: <span class="number">201</span>, <span class="attr">description</span>: <span class="string">&#x27;The article has been successfully favorited.&#x27;</span> &#125;)</span><br><span class="line">  <span class="meta">@ApiResponse</span>(&#123; <span class="attr">status</span>: <span class="number">403</span>, <span class="attr">description</span>: <span class="string">&#x27;Forbidden.&#x27;</span> &#125;)</span><br><span class="line">  <span class="meta">@Post</span>(<span class="string">&#x27;:slug/favorite&#x27;</span>)</span><br><span class="line">  <span class="keyword">async</span> favorite (<span class="meta">@User</span>(<span class="string">&#x27;id&#x27;</span>) userId: <span class="built_in">number</span>, <span class="meta">@Param</span>(<span class="string">&#x27;slug&#x27;</span>) slug) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="built_in">this</span>.articleService.favorite(userId, slug)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@ApiOperation</span>(&#123; <span class="attr">title</span>: <span class="string">&#x27;Unfavorite article&#x27;</span> &#125;)</span><br><span class="line">  <span class="meta">@ApiResponse</span>(&#123; <span class="attr">status</span>: <span class="number">201</span>, <span class="attr">description</span>: <span class="string">&#x27;The article has been successfully unfavorited.&#x27;</span> &#125;)</span><br><span class="line">  <span class="meta">@ApiResponse</span>(&#123; <span class="attr">status</span>: <span class="number">403</span>, <span class="attr">description</span>: <span class="string">&#x27;Forbidden.&#x27;</span> &#125;)</span><br><span class="line">  <span class="meta">@Delete</span>(<span class="string">&#x27;:slug/favorite&#x27;</span>)</span><br><span class="line">  <span class="keyword">async</span> unFavorite (<span class="meta">@User</span>(<span class="string">&#x27;id&#x27;</span>) userId: <span class="built_in">number</span>, <span class="meta">@Param</span>(<span class="string">&#x27;slug&#x27;</span>) slug) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="built_in">this</span>.articleService.unFavorite(userId, slug)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@ApiOperation</span>(&#123; <span class="attr">title</span>: <span class="string">&#x27;Get article feed&#x27;</span> &#125;)</span><br><span class="line">  <span class="meta">@ApiResponse</span>(&#123; <span class="attr">status</span>: <span class="number">200</span>, <span class="attr">description</span>: <span class="string">&#x27;Return article feed.&#x27;</span> &#125;)</span><br><span class="line">  <span class="meta">@ApiResponse</span>(&#123; <span class="attr">status</span>: <span class="number">403</span>, <span class="attr">description</span>: <span class="string">&#x27;Forbidden.&#x27;</span> &#125;)</span><br><span class="line">  <span class="meta">@Get</span>(<span class="string">&#x27;feed&#x27;</span>)</span><br><span class="line">  <span class="keyword">async</span> getFeed (<span class="meta">@User</span>(<span class="string">&#x27;id&#x27;</span>) userId: <span class="built_in">number</span>, <span class="meta">@Query</span>() query): <span class="built_in">Promise</span>&lt;ArticlesRO&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="built_in">this</span>.articleService.findFeed(userId, query)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  在 <a href="https://floatsyi.com/2019/12/30/%E8%BD%AC%E5%9E%8B%E8%AE%A1%E5%88%92%E4%B9%8B%E5%88%9D%E7%BA%A7%E5%90%8E%E7%AB%AF-%E4%B8%8A/">转型计划之初级后端(上)</a> 分析的那个 <a target="_blank" rel="noopener" href="https://github.com/topcoder-platform/challenge-api">challenge-api</a> 项目中， 路由注册是通过 app-routes.js 遍历一个中心化的 <a target="_blank" rel="noopener" href="https://sourcegraph.com/github.com/topcoder-platform/challenge-api/-/blob/src/routes.js#L2:4">‘./src/routes’</a> 将 ‘./src/controllers’ 中定义的 controllers 与 ‘./src/routes’ 中定义的 routes 给一一对应上的这种方式实现的。<br>  而 nest 中的 controller 却恰恰相反， 路由是完全去中心化的， 中心化的工作交给了 module 去做。<br>  可以看到 ArticleController 的  constructor 中莫名其妙多了一个 articleService， 这是通过 module 注入进来的，即所谓的控制反转， 依赖注入。<br>  具体请参考: <a target="_blank" rel="noopener" href="https://docs.nestjs.com/controllers">https://docs.nestjs.com/controllers</a></p>
<h3 id="分析-service"><a href="#分析-service" class="headerlink" title="分析 service"></a>分析 service</h3><p>接下来看 Service， Service 是大部分业务逻辑的承载者。<br>article.service.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; InjectRepository &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/typeorm&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; Repository, getRepository, DeleteResult &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; ArticleEntity &#125; <span class="keyword">from</span> <span class="string">&#x27;./article.entity&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; Comment &#125; <span class="keyword">from</span> <span class="string">&#x27;./comment.entity&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; UserEntity &#125; <span class="keyword">from</span> <span class="string">&#x27;../user/user.entity&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; FollowsEntity &#125; <span class="keyword">from</span> <span class="string">&#x27;../profile/follows.entity&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; CreateArticleDto &#125; <span class="keyword">from</span> <span class="string">&#x27;./dto&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; ArticleRO, ArticlesRO, CommentsRO &#125; <span class="keyword">from</span> <span class="string">&#x27;./article.interface&#x27;</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> slug <span class="keyword">from</span> <span class="string">&#x27;slug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ArticleService</span> </span>&#123;</span><br><span class="line">  <span class="title">constructor</span> (<span class="params"></span></span><br><span class="line"><span class="params">    <span class="meta">@InjectRepository</span>(ArticleEntity)</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="keyword">readonly</span> articleRepository: Repository&lt;ArticleEntity&gt;,</span></span><br><span class="line"><span class="params">    <span class="meta">@InjectRepository</span>(Comment)</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="keyword">readonly</span> commentRepository: Repository&lt;Comment&gt;,</span></span><br><span class="line"><span class="params">    <span class="meta">@InjectRepository</span>(UserEntity)</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="keyword">readonly</span> userRepository: Repository&lt;UserEntity&gt;,</span></span><br><span class="line"><span class="params">    <span class="meta">@InjectRepository</span>(FollowsEntity)</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="keyword">readonly</span> followsRepository: Repository&lt;FollowsEntity&gt;</span></span><br><span class="line"><span class="params">  </span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> findAll (query): <span class="built_in">Promise</span>&lt;ArticlesRO&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> qb = <span class="keyword">await</span> getRepository(ArticleEntity)</span><br><span class="line">      .createQueryBuilder(<span class="string">&#x27;article&#x27;</span>)</span><br><span class="line">      .leftJoinAndSelect(<span class="string">&#x27;article.author&#x27;</span>, <span class="string">&#x27;author&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    qb.where(<span class="string">&#x27;1 = 1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&#x27;tag&#x27;</span> <span class="keyword">in</span> query) &#123;</span><br><span class="line">      qb.andWhere(<span class="string">&#x27;article.tagList LIKE :tag&#x27;</span>, &#123; <span class="attr">tag</span>: <span class="string">`%<span class="subst">$&#123;query.tag&#125;</span>%`</span> &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&#x27;author&#x27;</span> <span class="keyword">in</span> query) &#123;</span><br><span class="line">      <span class="keyword">const</span> author = <span class="keyword">await</span> <span class="built_in">this</span>.userRepository.findOne(&#123;</span><br><span class="line">        <span class="attr">username</span>: query.author</span><br><span class="line">      &#125;)</span><br><span class="line">      qb.andWhere(<span class="string">&#x27;article.authorId = :id&#x27;</span>, &#123; <span class="attr">id</span>: author.id &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&#x27;favorited&#x27;</span> <span class="keyword">in</span> query) &#123;</span><br><span class="line">      <span class="keyword">const</span> author = <span class="keyword">await</span> <span class="built_in">this</span>.userRepository.findOne(&#123;</span><br><span class="line">        <span class="attr">username</span>: query.favorited</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="keyword">const</span> ids = author.favorites.map(<span class="function"><span class="params">el</span> =&gt;</span> el.id)</span><br><span class="line">      qb.andWhere(<span class="string">&#x27;article.authorId IN (:ids)&#x27;</span>, &#123; ids &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    qb.orderBy(<span class="string">&#x27;article.created&#x27;</span>, <span class="string">&#x27;DESC&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> articlesCount = <span class="keyword">await</span> qb.getCount()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&#x27;limit&#x27;</span> <span class="keyword">in</span> query) &#123;</span><br><span class="line">      qb.limit(query.limit)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&#x27;offset&#x27;</span> <span class="keyword">in</span> query) &#123;</span><br><span class="line">      qb.offset(query.offset)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> articles = <span class="keyword">await</span> qb.getMany()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; articles, articlesCount &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> findFeed (userId: <span class="built_in">number</span>, query): <span class="built_in">Promise</span>&lt;ArticlesRO&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> _follows = <span class="keyword">await</span> <span class="built_in">this</span>.followsRepository.find(&#123; <span class="attr">followerId</span>: userId &#125;)</span><br><span class="line">    <span class="keyword">const</span> ids = _follows.map(<span class="function"><span class="params">el</span> =&gt;</span> el.followingId)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> qb = <span class="keyword">await</span> getRepository(ArticleEntity)</span><br><span class="line">      .createQueryBuilder(<span class="string">&#x27;article&#x27;</span>)</span><br><span class="line">      .where(<span class="string">&#x27;article.authorId IN (:ids)&#x27;</span>, &#123; ids &#125;)</span><br><span class="line"></span><br><span class="line">    qb.orderBy(<span class="string">&#x27;article.created&#x27;</span>, <span class="string">&#x27;DESC&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> articlesCount = <span class="keyword">await</span> qb.getCount()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&#x27;limit&#x27;</span> <span class="keyword">in</span> query) &#123;</span><br><span class="line">      qb.limit(query.limit)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&#x27;offset&#x27;</span> <span class="keyword">in</span> query) &#123;</span><br><span class="line">      qb.offset(query.offset)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> articles = <span class="keyword">await</span> qb.getMany()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; articles, articlesCount &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> findOne (where): <span class="built_in">Promise</span>&lt;ArticleRO&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> article = <span class="keyword">await</span> <span class="built_in">this</span>.articleRepository.findOne(where)</span><br><span class="line">    <span class="keyword">return</span> &#123; article &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> addComment (slug: <span class="built_in">string</span>, commentData): <span class="built_in">Promise</span>&lt;ArticleRO&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> article = <span class="keyword">await</span> <span class="built_in">this</span>.articleRepository.findOne(&#123; slug &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> comment = <span class="keyword">new</span> Comment()</span><br><span class="line">    comment.body = commentData.body</span><br><span class="line"></span><br><span class="line">    article.comments.push(comment)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="built_in">this</span>.commentRepository.save(comment)</span><br><span class="line">    article = <span class="keyword">await</span> <span class="built_in">this</span>.articleRepository.save(article)</span><br><span class="line">    <span class="keyword">return</span> &#123; article &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> deleteComment (slug: <span class="built_in">string</span>, <span class="attr">id</span>: <span class="built_in">string</span>): <span class="built_in">Promise</span>&lt;ArticleRO&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> article = <span class="keyword">await</span> <span class="built_in">this</span>.articleRepository.findOne(&#123; slug &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> comment = <span class="keyword">await</span> <span class="built_in">this</span>.commentRepository.findOne(id)</span><br><span class="line">    <span class="keyword">const</span> deleteIndex = article.comments.findIndex(</span><br><span class="line">      <span class="function"><span class="params">_comment</span> =&gt;</span> _comment.id === comment.id</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (deleteIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> deleteComments = article.comments.splice(deleteIndex, <span class="number">1</span>)</span><br><span class="line">      <span class="keyword">await</span> <span class="built_in">this</span>.commentRepository.delete(deleteComments[<span class="number">0</span>].id)</span><br><span class="line">      article = <span class="keyword">await</span> <span class="built_in">this</span>.articleRepository.save(article)</span><br><span class="line">      <span class="keyword">return</span> &#123; article &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123; article &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> favorite (id: <span class="built_in">number</span>, <span class="attr">slug</span>: <span class="built_in">string</span>): <span class="built_in">Promise</span>&lt;ArticleRO&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> article = <span class="keyword">await</span> <span class="built_in">this</span>.articleRepository.findOne(&#123; slug &#125;)</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="built_in">this</span>.userRepository.findOne(id)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> isNewFavorite =</span><br><span class="line">      user.favorites.findIndex(<span class="function"><span class="params">_article</span> =&gt;</span> _article.id === article.id) &lt; <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> (isNewFavorite) &#123;</span><br><span class="line">      user.favorites.push(article)</span><br><span class="line">      article.favoriteCount++</span><br><span class="line"></span><br><span class="line">      <span class="keyword">await</span> <span class="built_in">this</span>.userRepository.save(user)</span><br><span class="line">      article = <span class="keyword">await</span> <span class="built_in">this</span>.articleRepository.save(article)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; article &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> unFavorite (id: <span class="built_in">number</span>, <span class="attr">slug</span>: <span class="built_in">string</span>): <span class="built_in">Promise</span>&lt;ArticleRO&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> article = <span class="keyword">await</span> <span class="built_in">this</span>.articleRepository.findOne(&#123; slug &#125;)</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="built_in">this</span>.userRepository.findOne(id)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> deleteIndex = user.favorites.findIndex(</span><br><span class="line">      <span class="function"><span class="params">_article</span> =&gt;</span> _article.id === article.id</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (deleteIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">      user.favorites.splice(deleteIndex, <span class="number">1</span>)</span><br><span class="line">      article.favoriteCount--</span><br><span class="line"></span><br><span class="line">      <span class="keyword">await</span> <span class="built_in">this</span>.userRepository.save(user)</span><br><span class="line">      article = <span class="keyword">await</span> <span class="built_in">this</span>.articleRepository.save(article)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; article &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> findComments (slug: <span class="built_in">string</span>): <span class="built_in">Promise</span>&lt;CommentsRO&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> article = <span class="keyword">await</span> <span class="built_in">this</span>.articleRepository.findOne(&#123; slug &#125;)</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">comments</span>: article.comments &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> create (</span><br><span class="line">    userId: <span class="built_in">number</span>,</span><br><span class="line">    <span class="attr">articleData</span>: CreateArticleDto</span><br><span class="line">  ): <span class="built_in">Promise</span>&lt;ArticleEntity&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> article = <span class="keyword">new</span> ArticleEntity()</span><br><span class="line">    article.title = articleData.title</span><br><span class="line">    article.description = articleData.description</span><br><span class="line">    article.slug = <span class="built_in">this</span>.slugify(articleData.title)</span><br><span class="line">    article.tagList = articleData.tagList || []</span><br><span class="line">    article.comments = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> newArticle = <span class="keyword">await</span> <span class="built_in">this</span>.articleRepository.save(article)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> author = <span class="keyword">await</span> <span class="built_in">this</span>.userRepository.findOne(&#123; <span class="attr">where</span>: &#123; <span class="attr">id</span>: userId &#125; &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(author.articles)) &#123;</span><br><span class="line">      author.articles.push(article)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      author.articles = [article]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="built_in">this</span>.userRepository.save(author)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> newArticle</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> update (slug: <span class="built_in">string</span>, <span class="attr">articleData</span>: <span class="built_in">any</span>): <span class="built_in">Promise</span>&lt;ArticleRO&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> toUpdate = <span class="keyword">await</span> <span class="built_in">this</span>.articleRepository.findOne(&#123; <span class="attr">slug</span>: slug &#125;)</span><br><span class="line">    <span class="keyword">const</span> updated = <span class="built_in">Object</span>.assign(toUpdate, articleData)</span><br><span class="line">    <span class="keyword">const</span> article = <span class="keyword">await</span> <span class="built_in">this</span>.articleRepository.save(updated)</span><br><span class="line">    <span class="keyword">return</span> &#123; article &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">delete</span> (slug: <span class="built_in">string</span>): <span class="built_in">Promise</span>&lt;DeleteResult&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="built_in">this</span>.articleRepository.delete(&#123; <span class="attr">slug</span>: slug &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  slugify (title: <span class="built_in">string</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;slug(title, &#123; lower: <span class="literal">true</span> &#125;)&#125;</span>-<span class="subst">$&#123;(</span></span></span><br><span class="line"><span class="subst"><span class="string">      (<span class="built_in">Math</span>.random() * <span class="built_in">Math</span>.pow(<span class="number">36</span>, <span class="number">6</span>)) |</span></span></span><br><span class="line"><span class="subst"><span class="string">      <span class="number">0</span></span></span></span><br><span class="line"><span class="subst"><span class="string">    ).toString(<span class="number">36</span>)&#125;</span>`</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  可以看到， article.interface article.entity Dto 这些周边文件都是这个 article.service 的组成部分<br>  其中 article.entity 为与数据库表一一对应的实体， 可以直接根据 ER 图编写，打开 article.entity 你可以看到很多 @ManyToOne @OneToMany 这样的注解</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ManyToOne</span>(<span class="function"><span class="params">type</span> =&gt;</span> UserEntity, <span class="function"><span class="params">user</span> =&gt;</span> user.articles)</span><br><span class="line"><span class="attr">author</span>: UserEntity;</span><br><span class="line"></span><br><span class="line"><span class="meta">@OneToMany</span>(<span class="function"><span class="params">type</span> =&gt;</span> Comment, <span class="function"><span class="params">comment</span> =&gt;</span> comment.article, &#123; <span class="attr">eager</span>: <span class="literal">true</span> &#125;)</span><br><span class="line"><span class="meta">@JoinColumn</span>()</span><br><span class="line"><span class="attr">comments</span>: Comment[];</span><br></pre></td></tr></table></figure>
<p>  这些注解顾名思义就是用来描述数据库实体之间的关系的， 实体之间的关系这部分也在 ER 图中表现出来了。<br>  而 DTO (Data Transfer Object), 可以看到都是 service 里面一些函数需要操作的数据对象， 这部分是前端传递过来的。<br>  而 article.interface 定义了各种 RO， 所谓 RO 我的理解是 return object 的缩写。 这些都是返回给前端的数据对象。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>  <strong>到这一步， 开发流程已经非常明朗了: 分析需求 &gt;&gt; 找出所有实体 &gt;&gt; 画 ER 图 &gt;&gt; 切分业务模块 &gt;&gt; 根据 ER 图编写 entity &gt;&gt; 编写 module 并在 app.module 导入 &gt;&gt; 编写 controller 的同时编写 service（此时按路由切分更细粒度的业务模块， 写好一个路由测试一个路由， 当然需要协同的除外）写完后在 module 导入 &gt;&gt; 使用 postman 测试路由 &gt;&gt; 完</strong></p>
<h2 id="改造样板"><a href="#改造样板" class="headerlink" title="改造样板"></a>改造样板</h2><p>现在已经分析完 <a target="_blank" rel="noopener" href="https://github.com/lujakob/nestjs-realworld-example-app">nestjs-realworld-example-app</a> 这个样板的基本开发逻辑， 可以开始动手改造了</p>
<h3 id="日志与异常捕获-exception-filters-and-logger"><a href="#日志与异常捕获-exception-filters-and-logger" class="headerlink" title="日志与异常捕获(exception-filters and logger)"></a>日志与异常捕获(exception-filters and logger)</h3><p>首先要做的是将 <a target="_blank" rel="noopener" href="https://github.com/topcoder-platform/challenge-api">challenge-api</a> 中的<a target="_blank" rel="noopener" href="https://sourcegraph.com/github.com/topcoder-platform/challenge-api/-/blob/src/common/errors.js">error.js</a> 和 <a target="_blank" rel="noopener" href="https://sourcegraph.com/github.com/topcoder-platform/challenge-api/-/blob/src/common/logger.js">logger.js</a> 重构过来<br><a target="_blank" rel="noopener" href="https://github.com/nestjs/nest">nestjs</a> 其实已经做了这件事情， error.js 对应 <a target="_blank" rel="noopener" href="https://docs.nestjs.com/exception-filters%EF%BC%8C">https://docs.nestjs.com/exception-filters，</a> 而 logger.js 对应 <a target="_blank" rel="noopener" href="https://docs.nestjs.com/techniques/logger">https://docs.nestjs.com/techniques/logger</a></p>
<p>  继续回过头来看 <a target="_blank" rel="noopener" href="https://sourcegraph.com/github.com/topcoder-platform/challenge-api/-/blob/src/common/logger.js#L10:55">logger.js</a><br>  logger.js<br>  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; createLogger, format, transports &#125; = <span class="built_in">require</span>(<span class="string">&#x27;winston&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> logger = createLogger(&#123;</span><br><span class="line">  <span class="attr">level</span>: config.LOG_LEVEL,</span><br><span class="line">  <span class="attr">transports</span>: [</span><br><span class="line">    <span class="keyword">new</span> transports.Console(&#123;</span><br><span class="line">      <span class="attr">format</span>: format.combine(</span><br><span class="line">        format.colorize(),</span><br><span class="line">        format.simple()</span><br><span class="line">      )</span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>  可以发现 logger.js 的引擎盖下(under the bonnet, 非常有意思的英语描述， 而中文习惯说: 驱动)是 <a target="_blank" rel="noopener" href="https://github.com/winstonjs/winston">winston</a>.<br>  <a target="_blank" rel="noopener" href="https://github.com/winstonjs/winston">winston</a> 可是一个好东西， 所以点开 <a target="_blank" rel="noopener" href="https://github.com/winstonjs/winston">winston</a>  点个 star， 然后继续<br>  知道 logger.js 是使用了 <a target="_blank" rel="noopener" href="https://github.com/winstonjs/winston">winston</a> 实现的后， 现在可以去 <a target="_blank" rel="noopener" href="https://www.npmjs.com/">npm</a> 搜索下关键词 <strong>nest winston</strong> 或者 <strong>Nest Logging</strong>。<br>  如果没有的话， 就需要自己实现了。不过一直很幸运， 找到一个 <a target="_blank" rel="noopener" href="https://github.com/gremo/nest-winston">nestjs-winston</a> 看 README.md 是符合要求的，点个 star 然后继续</p>
<blockquote>
<p>当你发现可见的人越来越少时，你就需要警惕了， 因为你不是走在时代的前沿， 就是走在未开垦的荒漠。其实这两点并不冲突。</p>
</blockquote>
<p>  安装运行时依赖: <code>npm install --save nest-winston winston</code> 然后根据 <a target="_blank" rel="noopener" href="https://github.com/gremo/nest-winston/blob/master/README.md">README.md</a> 文档的指示结合 <a target="_blank" rel="noopener" href="https://sourcegraph.com/github.com/topcoder-platform/challenge-api/-/blob/src/common/logger.js#L10:55">logger.js</a> 编写:<br>  config.ts<br>  <figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> SECRET = <span class="string">&#x27;secret-key&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> LOG_LEVEL = process.env.LOG_LEVEL || <span class="string">&#x27;debug&#x27;</span></span><br></pre></td></tr></table></figure></p>
<p>  app.controller.ts<br>  <figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Get, Controller, Inject, HttpException, HttpStatus &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; Logger &#125; <span class="keyword">from</span> <span class="string">&#x27;winston&#x27;</span></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;api&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppController</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"><span class="meta">@Inject</span>(<span class="string">&#x27;winston&#x27;</span>) <span class="keyword">private</span> <span class="keyword">readonly</span> logger: Logger</span>)</span> &#123; &#125;</span><br><span class="line">  <span class="meta">@Get</span>()</span><br><span class="line">  root (): <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.logger.info(<span class="string">&#x27;access &#123;/, GET&#125; route&#x27;</span>, [AppController.name])</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(<span class="string">&#x27;Forbidden&#x27;</span>, HttpStatus.FORBIDDEN)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello World!&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>  app.module.ts<br>  <figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; AppController &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.controller&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Connection &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; TypeOrmModule &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/typeorm&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; ArticleModule &#125; <span class="keyword">from</span> <span class="string">&#x27;./article/article.module&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; UserModule &#125; <span class="keyword">from</span> <span class="string">&#x27;./user/user.module&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; ProfileModule &#125; <span class="keyword">from</span> <span class="string">&#x27;./profile/profile.module&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; TagModule &#125; <span class="keyword">from</span> <span class="string">&#x27;./tag/tag.module&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; utilities <span class="keyword">as</span> nestWinstonModuleUtilities, WinstonModule &#125; <span class="keyword">from</span> <span class="string">&#x27;nest-winston&#x27;</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> winston <span class="keyword">from</span> <span class="string">&#x27;winston&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; LOG_LEVEL &#125; <span class="keyword">from</span> <span class="string">&#x27;./config&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; format, transports &#125; = winston</span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [</span><br><span class="line">    WinstonModule.forRoot(&#123;</span><br><span class="line">      <span class="comment">// options here</span></span><br><span class="line">      <span class="attr">level</span>: LOG_LEVEL,</span><br><span class="line">      <span class="attr">transports</span>: [</span><br><span class="line">        <span class="keyword">new</span> transports.Console(&#123;</span><br><span class="line">          <span class="attr">format</span>: format.combine(</span><br><span class="line">            format.colorize(),</span><br><span class="line">            nestWinstonModuleUtilities.format.nestLike()</span><br><span class="line">          )</span><br><span class="line">        &#125;)</span><br><span class="line">      ]</span><br><span class="line">    &#125;),</span><br><span class="line">    TypeOrmModule.forRoot(),</span><br><span class="line">    ArticleModule,</span><br><span class="line">    UserModule,</span><br><span class="line">    ProfileModule,</span><br><span class="line">    TagModule</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">controllers</span>: [</span><br><span class="line">    AppController</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">providers</span>: []</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationModule</span> </span>&#123;</span><br><span class="line">  <span class="title">constructor</span> (<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> connection: Connection</span>) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>  main.ts<br>  <figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; NestFactory &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/core&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; ApplicationModule &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.module&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; SwaggerModule, DocumentBuilder &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/swagger&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; WINSTON_MODULE_NEST_PROVIDER &#125; <span class="keyword">from</span> <span class="string">&#x27;nest-winston&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span> (<span class="params"></span>): <span class="title">Promise</span>&lt;<span class="title">void</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> appOptions = &#123; <span class="attr">cors</span>: <span class="literal">true</span> &#125;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> NestFactory.create(ApplicationModule, appOptions)</span><br><span class="line">  app.setGlobalPrefix(<span class="string">&#x27;api&#x27;</span>)</span><br><span class="line">  app.useLogger(app.get(WINSTON_MODULE_NEST_PROVIDER))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> options = <span class="keyword">new</span> DocumentBuilder()</span><br><span class="line">    .setTitle(<span class="string">&#x27;NestJS Realworld Example App&#x27;</span>)</span><br><span class="line">    .setDescription(<span class="string">&#x27;The Realworld API description&#x27;</span>)</span><br><span class="line">    .setVersion(<span class="string">&#x27;1.0&#x27;</span>)</span><br><span class="line">    .setBasePath(<span class="string">&#x27;api&#x27;</span>)</span><br><span class="line">    .addBearerAuth()</span><br><span class="line">    .build()</span><br><span class="line">  <span class="keyword">const</span> <span class="built_in">document</span> = SwaggerModule.createDocument(app, options)</span><br><span class="line">  SwaggerModule.setup(<span class="string">&#x27;/docs&#x27;</span>, app, <span class="built_in">document</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> app.listen(<span class="number">3000</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// eslint-disable-next-line @typescript-eslint/no-floating-promises</span></span><br><span class="line">bootstrap()</span><br></pre></td></tr></table></figure></p>
<p>  修改完成后，执行 <code>npm run start:watch</code>, 可以在 package.json 的 scripts 字段中看到<br>  package.json<br>  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">  <span class="attr">&quot;start&quot;</span>: <span class="string">&quot;node index.js&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;start:watch&quot;</span>: <span class="string">&quot;nodemon&quot;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>  npm run start:watch 实际执行的是 <a target="_blank" rel="noopener" href="https://github.com/remy/nodemon">nodemon</a>， 而 <a target="_blank" rel="noopener" href="https://github.com/remy/nodemon">nodemon</a> 实际执行的是 nodemon index.js -w ./src ， 而 nodemon index.js -w .src/ 实际执行的是 <code>require(&#39;ts-node/register&#39;);require(&#39;./src/main.ts&#39;)</code> 而…… 禁止套娃！！<br>  <a target="_blank" rel="noopener" href="https://github.com/remy/nodemon">nodemon</a> 可是一个好东西，<a target="_blank" rel="noopener" href="https://github.com/remy/nodemon">nodemon</a> 可以让应用支持热重载，这对节省开发时间很有帮助！ 所以点开  <a target="_blank" rel="noopener" href="https://github.com/remy/nodemon">nodemon</a> 点个 star， 然后继续</p>
<p>  服务启动后访问 <a target="_blank" rel="noopener" href="http://127.0.0.1:3000/api/api">http://127.0.0.1:3000/api/api</a>, 可以看到如下内容<br>  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;statusCode&quot;</span>: <span class="number">403</span>,</span><br><span class="line">  <span class="attr">&quot;message&quot;</span>: <span class="string">&quot;Forbidden&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>  没错, 响应了一个带有错误消息的 json， 这是因为我刚在 app.controller.ts 中硬编码了一个错误 <code>throw new HttpException(&#39;Forbidden&#39;, HttpStatus.FORBIDDEN)</code><br>  可以看到终端控制台上， 我主动调用的 <code>this.logger.info(&#39;access &#123;/, GET&#125; route&#39;, [AppController.name])</code> 日志被打印出来了，但是硬编码抛出的错误并没有被捕获处理！<br>  回过头来看 <a target="_blank" rel="noopener" href="https://github.com/topcoder-platform/challenge-api">challenge-api</a> 的入口文件 <a target="_blank" rel="noopener" href="https://sourcegraph.com/github.com/topcoder-platform/challenge-api/-/blob/app.js#L68:5">topcoder-platform/challenge-api/-/blob/app.js#L68:5</a> 可以发现 <a target="_blank" rel="noopener" href="https://github.com/topcoder-platform/challenge-api">challenge-api</a> 的作者是通过自定义一个全局中间件来做这件事情的，而 <a target="_blank" rel="noopener" href="https://github.com/nestjs/nest">nestjs</a> 中也有做这件事情的东西， 也就是上面链接的异常过滤器: <a target="_blank" rel="noopener" href="https://docs.nestjs.com/exception-filters">https://docs.nestjs.com/exception-filters</a><br>  所以任务来了， 我们实现一个异常过滤器来捕获并纪录程序抛出的错误:<br>  先创建好文件: <code>mkdir -p src/common/filters/;touch src/common/filters/all-exception.filter.ts</code><br>  all-exception.filter.ts<br>  <figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ExceptionFilter, Catch, ArgumentsHost, HttpException, HttpStatus, LoggerService  &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; Request, Response &#125; <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Catch</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AllExceptionsFilter</span> <span class="title">implements</span> <span class="title">ExceptionFilter</span> </span>&#123;</span><br><span class="line">    <span class="title">constructor</span> (<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> logger: LoggerService</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">catch</span> (exception: HttpException | <span class="built_in">Error</span>, <span class="attr">host</span>: ArgumentsHost) &#123;</span><br><span class="line">      <span class="keyword">const</span> ctx = host.switchToHttp()</span><br><span class="line">      <span class="keyword">const</span> response = ctx.getResponse&lt;Response&gt;()</span><br><span class="line">      <span class="keyword">const</span> request = ctx.getRequest&lt;Request&gt;()</span><br><span class="line">      <span class="keyword">const</span> status =</span><br><span class="line">        exception <span class="keyword">instanceof</span> HttpException</span><br><span class="line">          ? exception.getStatus()</span><br><span class="line">          : HttpStatus.INTERNAL_SERVER_ERROR</span><br><span class="line">      <span class="comment">// Get the location where the error was thrown from to use as a logging tag</span></span><br><span class="line">      <span class="keyword">const</span> stackTop =</span><br><span class="line">        exception.stack</span><br><span class="line">          .split(<span class="string">&quot;\n&quot;</span>)[<span class="number">1</span>]</span><br><span class="line">          .split(<span class="string">&#x27;at &#x27;</span>)[<span class="number">1</span>]</span><br><span class="line">          .split(<span class="string">&#x27; &#x27;</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> message = exception.message.message || exception.message</span><br><span class="line">      <span class="keyword">const</span> meta = exception.message.meta</span><br><span class="line">      <span class="keyword">const</span> logMessage = &#123;</span><br><span class="line">        status,</span><br><span class="line">        message,</span><br><span class="line">        meta,</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">this</span>.logger.error(<span class="built_in">JSON</span>.stringify(logMessage), stackTop, <span class="string">&quot;TRACE&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> method = request.method</span><br><span class="line">      <span class="keyword">const</span> url = request.url</span><br><span class="line">      <span class="keyword">const</span> requestTime = request.params.requestTime || <span class="number">0</span></span><br><span class="line"></span><br><span class="line">      <span class="built_in">this</span>.logger.log(</span><br><span class="line">        <span class="string">`<span class="subst">$&#123;method&#125;</span> <span class="subst">$&#123;url&#125;</span> - <span class="subst">$&#123;status&#125;</span> - <span class="subst">$&#123;<span class="built_in">Date</span>.now() - requestTime&#125;</span>ms`</span>,</span><br><span class="line">        <span class="string">&quot;Access&quot;</span></span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      response.status(status).send(&#123;</span><br><span class="line">        ...logMessage,</span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>  config.ts<br>  <figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; utilities <span class="keyword">as</span> nestWinstonModuleUtilities &#125; <span class="keyword">from</span> <span class="string">&#x27;nest-winston&#x27;</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> winston <span class="keyword">from</span> <span class="string">&#x27;winston&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; format, transports &#125; = winston</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> SECRET = <span class="string">&#x27;secret-key&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> LOG_LEVEL = process.env.LOG_LEVEL || <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> PORT = <span class="number">3000</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> LOGGER_CONFIG = &#123;</span><br><span class="line">  <span class="comment">// options here</span></span><br><span class="line">  <span class="attr">level</span>: LOG_LEVEL,</span><br><span class="line">  <span class="attr">transports</span>: [</span><br><span class="line">    <span class="keyword">new</span> transports.Console(&#123;</span><br><span class="line">      <span class="attr">format</span>: format.combine(</span><br><span class="line">        format.colorize(),</span><br><span class="line">        nestWinstonModuleUtilities.format.nestLike()</span><br><span class="line">      )</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="keyword">new</span> transports.File(&#123;</span><br><span class="line">      <span class="attr">filename</span>: <span class="string">&#x27;combined.log&#x27;</span>,</span><br><span class="line">      <span class="attr">level</span>: <span class="string">&#x27;info&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>  main.ts<br>  <figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; NestFactory &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/core&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; ApplicationModule &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.module&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; SwaggerModule, DocumentBuilder &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/swagger&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; WINSTON_MODULE_NEST_PROVIDER, WinstonModule &#125; <span class="keyword">from</span> <span class="string">&#x27;nest-winston&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; AllExceptionsFilter &#125; <span class="keyword">from</span> <span class="string">&#x27;./common/filters/all-exception.filter&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; LOGGER_CONFIG, PORT &#125; <span class="keyword">from</span> <span class="string">&#x27;./config&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> logger = WinstonModule.createLogger(LOGGER_CONFIG)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span> (<span class="params"></span>): <span class="title">Promise</span>&lt;<span class="title">void</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> appOptions = &#123; <span class="attr">cors</span>: <span class="literal">true</span>, logger &#125;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> NestFactory.create(ApplicationModule, appOptions)</span><br><span class="line">  app.setGlobalPrefix(<span class="string">&#x27;api&#x27;</span>)</span><br><span class="line">  app.useLogger(app.get(WINSTON_MODULE_NEST_PROVIDER))</span><br><span class="line">  app.useGlobalFilters(<span class="keyword">new</span> AllExceptionsFilter(logger))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> options = <span class="keyword">new</span> DocumentBuilder()</span><br><span class="line">    .setTitle(<span class="string">&#x27;NestJS Realworld Example App&#x27;</span>)</span><br><span class="line">    .setDescription(<span class="string">&#x27;The Realworld API description&#x27;</span>)</span><br><span class="line">    .setVersion(<span class="string">&#x27;1.0&#x27;</span>)</span><br><span class="line">    .setBasePath(<span class="string">&#x27;api&#x27;</span>)</span><br><span class="line">    .addBearerAuth()</span><br><span class="line">    .build()</span><br><span class="line">  <span class="keyword">const</span> <span class="built_in">document</span> = SwaggerModule.createDocument(app, options)</span><br><span class="line">  SwaggerModule.setup(<span class="string">&#x27;/docs&#x27;</span>, app, <span class="built_in">document</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> app.listen(<span class="number">3000</span>)</span><br><span class="line">  logger.log(<span class="string">`Server started on port <span class="subst">$&#123;PORT&#125;</span>`</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// eslint-disable-next-line @typescript-eslint/no-floating-promises</span></span><br><span class="line">bootstrap()</span><br></pre></td></tr></table></figure></p>
<p>  app.module.ts<br>  <figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; AppController &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.controller&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Connection &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; TypeOrmModule &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/typeorm&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; ArticleModule &#125; <span class="keyword">from</span> <span class="string">&#x27;./article/article.module&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; UserModule &#125; <span class="keyword">from</span> <span class="string">&#x27;./user/user.module&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; ProfileModule &#125; <span class="keyword">from</span> <span class="string">&#x27;./profile/profile.module&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; TagModule &#125; <span class="keyword">from</span> <span class="string">&#x27;./tag/tag.module&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; utilities <span class="keyword">as</span> nestWinstonModuleUtilities, WinstonModule &#125; <span class="keyword">from</span> <span class="string">&#x27;nest-winston&#x27;</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> winston <span class="keyword">from</span> <span class="string">&#x27;winston&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; LOGGER_CONFIG &#125; <span class="keyword">from</span> <span class="string">&#x27;./config&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; format, transports &#125; = winston</span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [</span><br><span class="line">    WinstonModule.forRoot(LOGGER_CONFIG),</span><br><span class="line">    TypeOrmModule.forRoot(),</span><br><span class="line">    ArticleModule,</span><br><span class="line">    UserModule,</span><br><span class="line">    ProfileModule,</span><br><span class="line">    TagModule</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">controllers</span>: [</span><br><span class="line">    AppController</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">providers</span>: []</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationModule</span> </span>&#123;</span><br><span class="line">  <span class="title">constructor</span> (<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> connection: Connection</span>) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>  再次打开 <a target="_blank" rel="noopener" href="http://127.0.0.1:3000/api/api">http://127.0.0.1:3000/api/api</a> 可以看到抛出的错误已经被成功捕获。但是这里有一个小问题， 那就是请求耗时并不准确， 下一步就是要解决这个问题。</p>
<h3 id="使用-interceptors-修复请求耗时不准的问题"><a href="#使用-interceptors-修复请求耗时不准的问题" class="headerlink" title="使用 interceptors 修复请求耗时不准的问题"></a>使用 interceptors 修复请求耗时不准的问题</h3><p>请求耗时不准确的原因是在 all-exception.filter.ts 文件中的这一行代码 <code>const requestTime = request.params.requestTime || 0</code><br>  很明显请求参数并没有带上 requestTime 这个属性， 这里我为了让 requestTime 有值设了一个 0。<br>  既然问题是请求参数没有 requestTime 这个属性，那么我们只要在服务器接受这个请求的时候， 给请求参数加上这个属性就行了<br>  这件事情可以由 <a target="_blank" rel="noopener" href="https://github.com/nestjs/nest">nestjs</a> 中的拦截器来做: <a target="_blank" rel="noopener" href="https://docs.nestjs.com/interceptors">https://docs.nestjs.com/interceptors</a><br>  由于 <a target="_blank" rel="noopener" href="https://github.com/nestjs/nest">nestjs</a> 中的拦截器用到了 <a target="_blank" rel="noopener" href="https://github.com/ReactiveX/rxjs">rxjs</a>， 而我因为没有使用的 <a target="_blank" rel="noopener" href="https://github.com/ReactiveX/rxjs">rxjs</a> 场景， 所以并没有仔细的读过 <a target="_blank" rel="noopener" href="https://github.com/ReactiveX/rxjs">rxjs</a> 文档，<br>  对里面的一些操作细节还不是很熟悉， 所以先花一两天时间把 <a target="_blank" rel="noopener" href="https://cn.rx.js.org/">rxjs 中文网</a> 的文档读一遍， 然后再继续写。<br>  突然感觉 <a target="_blank" rel="noopener" href="https://github.com/ReactiveX/rxjs">rxjs</a> 真的很热门， flutter app 里面也有使用 <a target="_blank" rel="noopener" href="https://github.com/ReactiveX/rxjs">rxjs</a> 管理数据状态的方案.<br>  花了半天时间， RxJS 的基本概念和基本使用都了解的差不多了， 继续：<br>  先新建文件 <code>mkdir -p src/common/interceptors/;touch src/common/interceptors/logging.interceptor.ts</code><br>  logging.interceptor.ts<br>  <figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">import</span> &#123;</span><br><span class="line">  Injectable,</span><br><span class="line">  NestInterceptor,</span><br><span class="line">  ExecutionContext,</span><br><span class="line">  CallHandler,</span><br><span class="line">  LoggerService</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; Observable &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; tap &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; Request, Response &#125; <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">LoggingInterceptor</span> <span class="title">implements</span> <span class="title">NestInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> logger: LoggerService</span>)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">  intercept(context: ExecutionContext, <span class="attr">next</span>: CallHandler): Observable&lt;<span class="built_in">any</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = context.switchToHttp()</span><br><span class="line">    <span class="keyword">const</span> response = ctx.getResponse&lt;Response&gt;()</span><br><span class="line">    <span class="keyword">const</span> request = ctx.getRequest&lt;Request&gt;()</span><br><span class="line">    <span class="keyword">const</span> method = request.method</span><br><span class="line">    <span class="keyword">const</span> url = request.url</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> requestTime = <span class="built_in">Date</span>.now()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add request time to params to be used in exception filters</span></span><br><span class="line">    request.params.requestTime = requestTime</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> next</span><br><span class="line">      .handle()</span><br><span class="line">      .pipe(</span><br><span class="line">        tap(<span class="function">() =&gt;</span></span><br><span class="line">          <span class="built_in">this</span>.logger.log(</span><br><span class="line">            <span class="string">`<span class="subst">$&#123;method&#125;</span> <span class="subst">$&#123;url&#125;</span> - <span class="subst">$&#123;response.res.statusCode&#125;</span> - <span class="subst">$&#123;<span class="built_in">Date</span>.now() - requestTime&#125;</span>ms`</span>,</span><br><span class="line">          ),</span><br><span class="line">        ),</span><br><span class="line">      )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>  main.ts<br>  <figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; NestFactory &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/core&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; ApplicationModule &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.module&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; SwaggerModule, DocumentBuilder &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/swagger&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; WINSTON_MODULE_NEST_PROVIDER, WinstonModule &#125; <span class="keyword">from</span> <span class="string">&#x27;nest-winston&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; LoggingInterceptor &#125; <span class="keyword">from</span> <span class="string">&#x27;./common/interceptors/logging.interceptor&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; AllExceptionsFilter &#125; <span class="keyword">from</span> <span class="string">&#x27;./common/filters/all-exception.filter&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; LOGGER_CONFIG, PORT &#125; <span class="keyword">from</span> <span class="string">&#x27;./config&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> logger = WinstonModule.createLogger(LOGGER_CONFIG)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span> (<span class="params"></span>): <span class="title">Promise</span>&lt;<span class="title">void</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> appOptions = &#123; <span class="attr">cors</span>: <span class="literal">true</span>, logger &#125;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> NestFactory.create(ApplicationModule, appOptions)</span><br><span class="line">  app.setGlobalPrefix(<span class="string">&#x27;api&#x27;</span>)</span><br><span class="line">  app.useLogger(app.get(WINSTON_MODULE_NEST_PROVIDER))</span><br><span class="line">  app.useGlobalInterceptors(<span class="keyword">new</span> LoggingInterceptor(logger))</span><br><span class="line">  app.useGlobalFilters(<span class="keyword">new</span> AllExceptionsFilter(logger))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> options = <span class="keyword">new</span> DocumentBuilder()</span><br><span class="line">    .setTitle(<span class="string">&#x27;NestJS Realworld Example App&#x27;</span>)</span><br><span class="line">    .setDescription(<span class="string">&#x27;The Realworld API description&#x27;</span>)</span><br><span class="line">    .setVersion(<span class="string">&#x27;1.0&#x27;</span>)</span><br><span class="line">    .setBasePath(<span class="string">&#x27;api&#x27;</span>)</span><br><span class="line">    .addBearerAuth()</span><br><span class="line">    .build()</span><br><span class="line">  <span class="keyword">const</span> <span class="built_in">document</span> = SwaggerModule.createDocument(app, options)</span><br><span class="line">  SwaggerModule.setup(<span class="string">&#x27;/docs&#x27;</span>, app, <span class="built_in">document</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> app.listen(<span class="number">3000</span>)</span><br><span class="line">  logger.log(<span class="string">`Server started on port <span class="subst">$&#123;PORT&#125;</span>`</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// eslint-disable-next-line @typescript-eslint/no-floating-promises</span></span><br><span class="line">bootstrap()</span><br></pre></td></tr></table></figure><br>  添加了这个全局拦截器后， 就能看到控制打印出每次请求的耗时了<br>  要想理解拦截器的执行过程还得看官方文档:  <a target="_blank" rel="noopener" href="https://docs.nestjs.com/interceptors#call-handler">https://docs.nestjs.com/interceptors#call-handler</a></p>
<blockquote>
<p>Consider, for example, an incoming POST /cats request. This request is destined for the create() handler defined inside the CatsController. If an interceptor which does not call the handle() method is called anywhere along the way, the create() method won’t be executed. Once handle() is called (and its Observable has been returned), the create() handler will be triggered. And once the response stream is received via the Observable, additional operations can be performed on the stream, and a final result returned to the caller.</p>
</blockquote>
<p>  当 HTTP 请求到达请求的路由方法之前，会被拦截器拦截， 并执行拦截器实现的 intercept 方法， intercept 执行完成后将 next.handle() 返回的 Observable 添加一些 <a target="_blank" rel="noopener" href="https://github.com/ReactiveX/rxjs">RxJS</a> operators(Pipeable 操作符)， 根据<a target="_blank" rel="noopener" href="https://cn.rx.js.org/">rxjs 中文网</a> 的文档我们知道 <a target="_blank" rel="noopener" href="https://github.com/ReactiveX/rxjs">RxJS</a> operators 将返回一个新的 Observable, <a target="_blank" rel="noopener" href="https://github.com/nestjs/nest">nestjs</a> 框架得到了intercept 方法返回的 Observable，然后执行请求的路由方法，并在此之后， 将得到的 Observable 进行 subscribe(订阅执行)， 因此我们在路由方法之前与之后插入了代码逻辑， 既所谓的 面向切面编程(AOP).</p>
<h3 id="使用-pipes-处理错误的请求体"><a href="#使用-pipes-处理错误的请求体" class="headerlink" title="使用 pipes 处理错误的请求体"></a>使用 pipes 处理错误的请求体</h3><p>接下来， 试想这样一个场景， 前端请求一个路由， 但是传递了一个错误的，不符合要求的请求体参数，一般情况下我们会在路由方法中做参数验证，如果验证未通过，就将错误响应给前端。但是，如果每个路由都这么做，会有很多冗余代码, 不够优雅。而 <a target="_blank" rel="noopener" href="https://github.com/nestjs/nest">nestjs</a> 有一个东西叫 pipes 可以解决这个问题: <a target="_blank" rel="noopener" href="https://docs.nestjs.com/pipes">https://docs.nestjs.com/pipes</a><br><code>mkdir -p src/common/pipes/;touch src/common/pipes/body-validation.pipe.ts</code><br>body-validation.pipe.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  PipeTransform,</span><br><span class="line">  Injectable,</span><br><span class="line">  ArgumentMetadata,</span><br><span class="line">  BadRequestException,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; validate &#125; <span class="keyword">from</span> <span class="string">&quot;class-validator&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; plainToClass &#125; <span class="keyword">from</span> <span class="string">&quot;class-transformer&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidationPipe</span> <span class="title">implements</span> <span class="title">PipeTransform</span>&lt;<span class="title">any</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="title">transform</span>(<span class="params">value: <span class="built_in">any</span>, &#123; metatype &#125;: ArgumentMetadata</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// Account for an empty request body</span></span><br><span class="line">    <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">      value = &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!metatype || !<span class="built_in">this</span>.toValidate(metatype)) &#123;</span><br><span class="line">      <span class="keyword">return</span> value</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">object</span> = plainToClass(metatype, value)</span><br><span class="line">    <span class="keyword">const</span> errors = <span class="keyword">await</span> validate(<span class="built_in">object</span>, &#123;</span><br><span class="line">      <span class="attr">forbidUnknownValues</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">whitelist</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">forbidNonWhitelisted</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (errors.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// Top-level errors</span></span><br><span class="line">      <span class="keyword">const</span> topLevelErrors = errors</span><br><span class="line">        .filter(<span class="function"><span class="params">v</span> =&gt;</span> v.constraints)</span><br><span class="line">        .map(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">property</span>: error.property,</span><br><span class="line">            <span class="attr">constraints</span>: <span class="built_in">Object</span>.values(error.constraints),</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Nested errors</span></span><br><span class="line">      <span class="keyword">const</span> nestedErrors = errors</span><br><span class="line">        .filter(<span class="function"><span class="params">v</span> =&gt;</span> !v.constraints)</span><br><span class="line">        .map(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> validationErrors = <span class="built_in">this</span>.getValidationErrorsFromChildren(</span><br><span class="line">            error.property,</span><br><span class="line">            error.children,</span><br><span class="line">          )</span><br><span class="line">          <span class="keyword">return</span> validationErrors</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BadRequestException(&#123;</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&quot;Validation failed&quot;</span>,</span><br><span class="line">        <span class="attr">meta</span>: topLevelErrors.concat(...nestedErrors),</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> value</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> toValidate(metatype: <span class="built_in">any</span>): <span class="built_in">boolean</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> types: <span class="built_in">Array</span>&lt;<span class="function">() =&gt;</span> <span class="built_in">any</span>&gt; = [<span class="built_in">String</span>, <span class="built_in">Boolean</span>, <span class="built_in">Number</span>, <span class="built_in">Array</span>, <span class="built_in">Object</span>]</span><br><span class="line">    <span class="keyword">return</span> !types.includes(metatype)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="title">getValidationErrorsFromChildren</span>(<span class="params">parent, children, errors = []</span>)</span> &#123;</span><br><span class="line">    children.forEach(<span class="function"><span class="params">child</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (child.constraints) &#123;</span><br><span class="line">        errors.push(&#123;</span><br><span class="line">          <span class="attr">property</span>: <span class="string">`<span class="subst">$&#123;parent&#125;</span>.<span class="subst">$&#123;child.property&#125;</span>`</span>,</span><br><span class="line">          <span class="attr">constraints</span>: <span class="built_in">Object</span>.values(child.constraints),</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.getValidationErrorsFromChildren(</span><br><span class="line">          <span class="string">`<span class="subst">$&#123;parent&#125;</span>.<span class="subst">$&#123;child.property&#125;</span>`</span>,</span><br><span class="line">          child.children,</span><br><span class="line">          errors,</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> errors</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  main.ts<br>  <figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; NestFactory &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/core&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; ApplicationModule &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.module&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; SwaggerModule, DocumentBuilder &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/swagger&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; WINSTON_MODULE_NEST_PROVIDER, WinstonModule &#125; <span class="keyword">from</span> <span class="string">&#x27;nest-winston&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; LoggingInterceptor &#125; <span class="keyword">from</span> <span class="string">&#x27;./common/interceptors/logging.interceptor&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; AllExceptionsFilter &#125; <span class="keyword">from</span> <span class="string">&#x27;./common/filters/all-exception.filter&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; ValidationPipe &#125; <span class="keyword">from</span> <span class="string">&#x27;./common/pipes/body-validation.pipe&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; LOGGER_CONFIG, PORT &#125; <span class="keyword">from</span> <span class="string">&#x27;./config&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> logger = WinstonModule.createLogger(LOGGER_CONFIG)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span> (<span class="params"></span>): <span class="title">Promise</span>&lt;<span class="title">void</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> appOptions = &#123; <span class="attr">cors</span>: <span class="literal">true</span>, logger &#125;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> NestFactory.create(ApplicationModule, appOptions)</span><br><span class="line">  app.setGlobalPrefix(<span class="string">&#x27;api&#x27;</span>)</span><br><span class="line">  app.useLogger(app.get(WINSTON_MODULE_NEST_PROVIDER))</span><br><span class="line">  app.useGlobalInterceptors(<span class="keyword">new</span> LoggingInterceptor(logger))</span><br><span class="line">  app.useGlobalFilters(<span class="keyword">new</span> AllExceptionsFilter(logger))</span><br><span class="line">  app.useGlobalPipes(<span class="keyword">new</span> ValidationPipe())</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> options = <span class="keyword">new</span> DocumentBuilder()</span><br><span class="line">    .setTitle(<span class="string">&#x27;NestJS Realworld Example App&#x27;</span>)</span><br><span class="line">    .setDescription(<span class="string">&#x27;The Realworld API description&#x27;</span>)</span><br><span class="line">    .setVersion(<span class="string">&#x27;1.0&#x27;</span>)</span><br><span class="line">    .setBasePath(<span class="string">&#x27;api&#x27;</span>)</span><br><span class="line">    .addBearerAuth()</span><br><span class="line">    .build()</span><br><span class="line">  <span class="keyword">const</span> <span class="built_in">document</span> = SwaggerModule.createDocument(app, options)</span><br><span class="line">  SwaggerModule.setup(<span class="string">&#x27;/docs&#x27;</span>, app, <span class="built_in">document</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> app.listen(<span class="number">3000</span>)</span><br><span class="line">  logger.log(<span class="string">`Server started on port <span class="subst">$&#123;PORT&#125;</span>`</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// eslint-disable-next-line @typescript-eslint/no-floating-promises</span></span><br><span class="line">bootstrap()</span><br></pre></td></tr></table></figure></p>
<p>  点开 <a target="_blank" rel="noopener" href="http://127.0.0.1:3000/docs">http://127.0.0.1:3000/docs</a> 找到 POST ​/users​/login 点击 Try it out， 然后 Execute，可以看到 Response body 如下:<br>  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;status&quot;</span>: <span class="number">400</span>,</span><br><span class="line">  <span class="attr">&quot;message&quot;</span>: <span class="string">&quot;Validation failed&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;meta&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;property&quot;</span>: <span class="string">&quot;username&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;constraints&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;username should not be empty&quot;</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;property&quot;</span>: <span class="string">&quot;email&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;constraints&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;email should not be empty&quot;</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;property&quot;</span>: <span class="string">&quot;password&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;constraints&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;password should not be empty&quot;</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>  pipes 与 exception filters 基本上是一样的， 只不过是一个验证或转换请求体，一个捕获异常。pipes 中使用了两个库: <a target="_blank" rel="noopener" href="https://github.com/typestack/class-validator">class-validator</a> 和 <a target="_blank" rel="noopener" href="https://github.com/typestack/class-transformer">class-transformer</a>，<br>  一个是对类成员的赋值进行验证， 一个是将字面量对象转为类对象或其实例。都是很好的东西， 所以点个 star 继续。</p>
<h3 id="其他-Guards-and-Middleware"><a href="#其他-Guards-and-Middleware" class="headerlink" title="其他(Guards and Middleware)"></a>其他(Guards and Middleware)</h3><p>到这里这篇文章就可以结束了，基本概念只有 Guards 与 Middleware 没有涉及， Middleware 可以参考这个样板的:<br>auth.middleware.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; HttpException &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common/exceptions/http.exception&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; NestMiddleware, HttpStatus, Injectable &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; ExtractJwt, Strategy &#125; <span class="keyword">from</span> <span class="string">&#x27;passport-jwt&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; Request, Response, NextFunction &#125; <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> jwt <span class="keyword">from</span> <span class="string">&#x27;jsonwebtoken&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; SECRET &#125; <span class="keyword">from</span> <span class="string">&#x27;../config&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; UserService &#125; <span class="keyword">from</span> <span class="string">&#x27;./user.service&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthMiddleware</span> <span class="title">implements</span> <span class="title">NestMiddleware</span> </span>&#123;</span><br><span class="line">  <span class="title">constructor</span> (<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> userService: UserService</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> use (req: Request, <span class="attr">res</span>: Response, <span class="attr">next</span>: NextFunction) &#123;</span><br><span class="line">    <span class="keyword">const</span> authHeaders = req.headers.authorization</span><br><span class="line">    <span class="keyword">if</span> (authHeaders &amp;&amp; (authHeaders <span class="keyword">as</span> <span class="built_in">string</span>).split(<span class="string">&#x27; &#x27;</span>)[<span class="number">1</span>]) &#123;</span><br><span class="line">      <span class="keyword">const</span> token = (authHeaders <span class="keyword">as</span> <span class="built_in">string</span>).split(<span class="string">&#x27; &#x27;</span>)[<span class="number">1</span>]</span><br><span class="line">      <span class="keyword">const</span> decoded: <span class="built_in">any</span> = jwt.verify(token, SECRET)</span><br><span class="line">      <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="built_in">this</span>.userService.findById(decoded.id)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(<span class="string">&#x27;User not found.&#x27;</span>, HttpStatus.UNAUTHORIZED)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      req.user = user.user</span><br><span class="line">      next()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(<span class="string">&#x27;Not authorized.&#x27;</span>, HttpStatus.UNAUTHORIZED)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  而使用也可以在 module 中看到:<br>  user.module.ts<br>  <figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; MiddlewareConsumer, Module, NestModule, RequestMethod &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; UserController &#125; <span class="keyword">from</span> <span class="string">&#x27;./user.controller&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; TypeOrmModule &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/typeorm&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; UserEntity &#125; <span class="keyword">from</span> <span class="string">&#x27;./user.entity&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; UserService &#125; <span class="keyword">from</span> <span class="string">&#x27;./user.service&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; AuthMiddleware &#125; <span class="keyword">from</span> <span class="string">&#x27;./auth.middleware&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [TypeOrmModule.forFeature([UserEntity])],</span><br><span class="line">  <span class="attr">providers</span>: [UserService],</span><br><span class="line">  <span class="attr">controllers</span>: [</span><br><span class="line">    UserController</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">exports</span>: [UserService]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserModule</span> <span class="title">implements</span> <span class="title">NestModule</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> configure (consumer: MiddlewareConsumer) &#123;</span><br><span class="line">    consumer</span><br><span class="line">      .apply(AuthMiddleware)</span><br><span class="line">      .forRoutes(&#123; <span class="attr">path</span>: <span class="string">&#x27;user&#x27;</span>, <span class="attr">method</span>: RequestMethod.GET &#125;, &#123; <span class="attr">path</span>: <span class="string">&#x27;user&#x27;</span>, <span class="attr">method</span>: RequestMethod.PUT &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>  Guards 与 Middleware 区别在官方文档里说的很清楚: <a target="_blank" rel="noopener" href="https://docs.nestjs.com/guards">https://docs.nestjs.com/guards</a><br>  还有一个区别就是 Middleware 的应用是中心化的， 而 Guards 的应用是去中心化的，就和路由的 HTTP 方法注解一样。</p>
<h3 id="完"><a href="#完" class="headerlink" title="完"></a>完</h3><p>本篇完。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%88%9D%E7%BA%A7%E5%90%8E%E7%AB%AF/" rel="tag"># 初级后端</a>
              <a href="/tags/%E8%BD%AC%E5%9E%8B%E8%AE%A1%E5%88%92/" rel="tag"># 转型计划</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2019/12/30/%E8%BD%AC%E5%9E%8B%E8%AE%A1%E5%88%92%E4%B9%8B%E5%88%9D%E7%BA%A7%E5%90%8E%E7%AB%AF-%E4%B8%8A/" rel="prev" title="转型计划之初级后端(上)">
      <i class="fa fa-chevron-left"></i> 转型计划之初级后端(上)
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/01/01/Reactive-Extensions-Library-for-JavaScript-Rxjs/" rel="next" title="Reactive Extensions Library for JavaScript: Rxjs">
      Reactive Extensions Library for JavaScript: Rxjs <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">1.</span> <span class="nav-text">参考</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B5%84%E6%BA%90"><span class="nav-number">2.</span> <span class="nav-text">资源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">3.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="nav-number">4.</span> <span class="nav-text">前置知识</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E6%9E%90%E6%A0%B7%E6%9D%BF"><span class="nav-number">5.</span> <span class="nav-text">分析样板</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%BB%E6%89%BE%E5%90%88%E9%80%82%E7%9A%84%E6%A0%B7%E6%9D%BF"><span class="nav-number">5.1.</span> <span class="nav-text">寻找合适的样板</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-mysql-%E5%AE%B9%E5%99%A8"><span class="nav-number">5.2.</span> <span class="nav-text">使用 mysql 容器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E6%9E%90%E5%85%A5%E5%8F%A3%E6%96%87%E4%BB%B6"><span class="nav-number">5.3.</span> <span class="nav-text">分析入口文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E6%9E%90-module"><span class="nav-number">5.4.</span> <span class="nav-text">分析 module</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E6%9E%90-controller"><span class="nav-number">5.5.</span> <span class="nav-text">分析 controller</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E6%9E%90-service"><span class="nav-number">5.6.</span> <span class="nav-text">分析 service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">5.7.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%94%B9%E9%80%A0%E6%A0%B7%E6%9D%BF"><span class="nav-number">6.</span> <span class="nav-text">改造样板</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%A5%E5%BF%97%E4%B8%8E%E5%BC%82%E5%B8%B8%E6%8D%95%E8%8E%B7-exception-filters-and-logger"><span class="nav-number">6.1.</span> <span class="nav-text">日志与异常捕获(exception-filters and logger)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-interceptors-%E4%BF%AE%E5%A4%8D%E8%AF%B7%E6%B1%82%E8%80%97%E6%97%B6%E4%B8%8D%E5%87%86%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">6.2.</span> <span class="nav-text">使用 interceptors 修复请求耗时不准的问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-pipes-%E5%A4%84%E7%90%86%E9%94%99%E8%AF%AF%E7%9A%84%E8%AF%B7%E6%B1%82%E4%BD%93"><span class="nav-number">6.3.</span> <span class="nav-text">使用 pipes 处理错误的请求体</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E4%BB%96-Guards-and-Middleware"><span class="nav-number">6.4.</span> <span class="nav-text">其他(Guards and Middleware)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%8C"><span class="nav-number">6.5.</span> <span class="nav-text">完</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="backtolife"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">backtolife</p>
  <div class="site-description" itemprop="description">21 世纪两大浪漫, 五线谱与二进制.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">64</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">104</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/backtolife2021" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;backtolife2021" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://codepen.io/FloatingShuYin/#" title="CodePen → https:&#x2F;&#x2F;codepen.io&#x2F;FloatingShuYin&#x2F;#" rel="noopener" target="_blank"><i class="fab fa-codepen fa-fw"></i>CodePen</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">backtolife</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        






<script>
  (function() {
    function leancloudSelector(url) {
      url = encodeURI(url);
      return document.getElementById(url).querySelector('.leancloud-visitors-count');
    }

    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.id);
      var title = visitors.dataset.flagTitle;

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url })))
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            leancloudSelector(url).innerText = counter.time + 1;
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              });
          } else {
              Counter('post', '/classes/Counter', { title, url, time: 1 })
                .then(response => response.json())
                .then(() => {
                  leancloudSelector(url).innerText = 1;
                })
                .catch(error => {
                  console.error('Failed to create', error);
                });
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.id);
      });

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url: { '$in': entries } })))
        .then(response => response.json())
        .then(({ results }) => {
          for (let url of entries) {
            let target = results.find(item => item.url === url);
            leancloudSelector(url).innerText = target ? target.time : 0;
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    let { app_id, app_key, server_url } = {"enable":true,"app_id":"bH5pXa93c9rYkIe6zzKkty1d-gzGzoHsz","app_key":"REvpf8v4c6CK9EgLRpFomYuL","server_url":null,"security":false};
    function fetchData(api_server) {
      var Counter = (method, url, data) => {
        return fetch(`${api_server}/1.1${url}`, {
          method,
          headers: {
            'X-LC-Id'     : app_id,
            'X-LC-Key'    : app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    }

    let api_server = app_id.slice(-9) !== '-MdYXbMMI' ? server_url : `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com`;

    if (api_server) {
      fetchData(api_server);
    } else {
      fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id)
        .then(response => response.json())
        .then(({ api_server }) => {
          fetchData('https://' + api_server);
        });
    }
  })();
</script>


      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://backtolife.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  var disqus_config = function() {
    this.page.url = "http://floatsyi.com/2019/12/31/%E8%BD%AC%E5%9E%8B%E8%AE%A1%E5%88%92%E4%B9%8B%E5%88%9D%E7%BA%A7%E5%90%8E%E7%AB%AF-%E4%B8%AD/";
    this.page.identifier = "2019/12/31/转型计划之初级后端-中/";
    this.page.title = "转型计划之初级后端(中)";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://backtolife.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

</body>
</html>
